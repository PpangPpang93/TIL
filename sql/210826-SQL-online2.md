SQL 온라인 강의3

# 대중교통 데이터 분석(T-money)

# 테이블 생성 및 데이터 입력
 - 일자/호선번호/역번호/역이름/시간대별상차,하차인원/해당 자료 업데이트 시간
 - 일단 SQL에서 작업할 수 있게 읽어오기

CREATE TABLE TB_PBTRNSP_DATA
(
  DE VARCHAR2(400) NOT NULL
, HO_LN VARCHAR2(400) NOT NULL
, STATN_NO VARCHAR2(400) NOT NULL
, STATN_NM VARCHAR2(4000)
, FROM_04_HOUR_TO_05_HOUR_TK VARCHAR2(4000)
, FROM_04_HOUR_TO_05_HOUR_GFF VARCHAR2(4000)
, FROM_05_HOUR_TO_06_HOUR_TK VARCHAR2(4000)
, FROM_05_HOUR_TO_06_HOUR_GFF VARCHAR2(4000)
, FROM_06_HOUR_TO_07_HOUR_TK VARCHAR2(4000)
, FROM_06_HOUR_TO_07_HOUR_GFF VARCHAR2(4000)
, FROM_07_HOUR_TO_08_HOUR_TK VARCHAR2(4000)
, FROM_07_HOUR_TO_08_HOUR_GFF VARCHAR2(4000)
, FROM_08_HOUR_TO_09_HOUR_TK VARCHAR2(4000)
, FROM_08_HOUR_TO_09_HOUR_GFF VARCHAR2(4000)
, FROM_09_HOUR_TO_10_HOUR_TK VARCHAR2(4000)
, FROM_09_HOUR_TO_10_HOUR_GFF VARCHAR2(4000)
, FROM_10_HOUR_TO_11_HOUR_TK VARCHAR2(4000)
, FROM_10_HOUR_TO_11_HOUR_GFF VARCHAR2(4000)
, FROM_11_HOUR_TO_12_HOUR_TK VARCHAR2(4000)
, FROM_11_HOUR_TO_12_HOUR_GFF VARCHAR2(4000)
, FROM_12_HOUR_TO_13_HOUR_TK VARCHAR2(4000)
, FROM_12_HOUR_TO_13_HOUR_GFF VARCHAR2(4000)
, FROM_13_HOUR_TO_14_HOUR_TK VARCHAR2(4000)
, FROM_13_HOUR_TO_14_HOUR_GFF VARCHAR2(4000)
, FROM_14_HOUR_TO_15_HOUR_TK VARCHAR2(4000)
, FROM_14_HOUR_TO_15_HOUR_GFF VARCHAR2(4000)
, FROM_15_HOUR_TO_16_HOUR_TK VARCHAR2(4000)
, FROM_15_HOUR_TO_16_HOUR_GFF VARCHAR2(4000)
, FROM_16_HOUR_TO_17_HOUR_TK VARCHAR2(4000)
, FROM_16_HOUR_TO_17_HOUR_GFF VARCHAR2(4000)
, FROM_17_HOUR_TO_18_HOUR_TK VARCHAR2(4000)
, FROM_17_HOUR_TO_18_HOUR_GFF VARCHAR2(4000)
, FROM_18_HOUR_TO_19_HOUR_TK VARCHAR2(4000)
, FROM_18_HOUR_TO_19_HOUR_GFF VARCHAR2(4000)
, FROM_19_HOUR_TO_20_HOUR_TK VARCHAR2(4000)
, FROM_19_HOUR_TO_20_HOUR_GFF VARCHAR2(4000)
, FROM_20_HOUR_TO_21_HOUR_TK VARCHAR2(4000)
, FROM_20_HOUR_TO_21_HOUR_GFF VARCHAR2(4000)
, FROM_21_HOUR_TO_22_HOUR_TK VARCHAR2(4000)
, FROM_21_HOUR_TO_22_HOUR_GFF VARCHAR2(4000)
, FROM_22_HOUR_TO_23_HOUR_TK VARCHAR2(4000)
, FROM_22_HOUR_TO_23_HOUR_GFF VARCHAR2(4000)
, FROM_23_HOUR_TO_24_HOUR_TK VARCHAR2(4000)
, FROM_23_HOUR_TO_24_HOUR_GFF VARCHAR2(4000)
, FROM_24_HOUR_TO_01_HOUR_TK VARCHAR2(4000)
, FROM_24_HOUR_TO_01_HOUR_GFF VARCHAR2(4000)
, FROM_01_HOUR_TO_02_HOUR_TK VARCHAR2(4000)
, FROM_01_HOUR_TO_02_HOUR_GFF VARCHAR2(4000)
, FROM_02_HOUR_TO_03_HOUR_TK VARCHAR2(4000)
, FROM_02_HOUR_TO_03_HOUR_GFF VARCHAR2(4000)
, FROM_03_HOUR_TO_04_HOUR_TK VARCHAR2(4000)
, FROM_03_HOUR_TO_04_HOUR_GFF VARCHAR2(4000)
, WORK_DT VARCHAR2(4000)      
);


 - SELECT * FROM TB_PBTRNSP_DATA;  # 데이터 잘 들어갔는지 조회해보기
 - SELECT COUNT(*) FROM TB_PBTRNSP_DATA;   # 데이터 행의 수 확인 (605건)

 => 데이터 열의 수가 많으므로 가공이 필요함

  - 새로운 테이블 만들기
  - 역번호/역명/호선명/기준년월/시작시간/종료시간/승하차구분코드(TK,GF)/인원수 구분
  - 기본키 : 역번호/연월/시작시간/종료시간/승하차시간

CREATE TABLE TB_PBTRNSP
(
  STATN_NO NUMBER(10) NOT NULL
, STATN_NM VARCHAR2(50)
, HO_LN VARCHAR2(50)
, STD_MT CHAR(6) NOT NULL
, BEGIN_TIME CHAR(4) NOT NULL
, END_TIME CHAR(4) NOT NULL
, TKCAR_GFF_SE_CD CHAR(2) NOT NULL --'TK':승차, 'GF':하차
, NMPR_CNT NUMBER(15) --인원수
, CONSTRAINT TB_PBTRNSP_PK PRIMARY KEY (STATN_NO, STD_MT, BEGIN_TIME, END_TIME, TKCAR_GFF_SE_CD)
);

 - 위에 만들어둔 테이블에 넣기위해 엑셀 데이터를 가공

INSERT INTO TB_PBTRNSP
SELECT A.STATN_NO, A.STATN_NM, A.HO_LN, '202010' AS STD_MT

## 48개 데이터를 시간대별로 레벨 설정(승,하차 이므로 2번 반복)

     , CASE WHEN A.LVL = 1  THEN '0400' WHEN A.LVL = 2  THEN '0400' WHEN A.LVL = 3  THEN '0500' WHEN A.LVL = 4  THEN '0500' WHEN A.LVL = 5  THEN '0600' WHEN A.LVL = 6  THEN '0600'
            WHEN A.LVL = 7  THEN '0700' WHEN A.LVL = 8  THEN '0700' WHEN A.LVL = 9  THEN '0800' WHEN A.LVL = 10 THEN '0800' WHEN A.LVL = 11 THEN '0900' WHEN A.LVL = 12 THEN '0900'
            WHEN A.LVL = 13 THEN '1000' WHEN A.LVL = 14 THEN '1000' WHEN A.LVL = 15 THEN '1100' WHEN A.LVL = 16 THEN '1100' WHEN A.LVL = 17 THEN '1200' WHEN A.LVL = 18 THEN '1200'
            WHEN A.LVL = 19 THEN '1300' WHEN A.LVL = 20 THEN '1300' WHEN A.LVL = 21 THEN '1400' WHEN A.LVL = 22 THEN '1400' WHEN A.LVL = 23 THEN '1500' WHEN A.LVL = 24 THEN '1500'
            WHEN A.LVL = 25 THEN '1600' WHEN A.LVL = 26 THEN '1600' WHEN A.LVL = 27 THEN '1700' WHEN A.LVL = 28 THEN '1700' WHEN A.LVL = 29 THEN '1800' WHEN A.LVL = 30 THEN '1800'
            WHEN A.LVL = 31 THEN '1900' WHEN A.LVL = 32 THEN '1900' WHEN A.LVL = 33 THEN '2000' WHEN A.LVL = 34 THEN '2000' WHEN A.LVL = 35 THEN '2100' WHEN A.LVL = 36 THEN '2100'
            WHEN A.LVL = 37 THEN '2200' WHEN A.LVL = 38 THEN '2200' WHEN A.LVL = 39 THEN '2300' WHEN A.LVL = 40 THEN '2300' WHEN A.LVL = 41 THEN '2400' WHEN A.LVL = 42 THEN '2400'
            WHEN A.LVL = 43 THEN '0100' WHEN A.LVL = 44 THEN '0100' WHEN A.LVL = 45 THEN '0200' WHEN A.LVL = 46 THEN '0200' WHEN A.LVL = 47 THEN '0300' WHEN A.LVL = 48 THEN '0300'
            ELSE '' END AS BEGIN_TIME		# 승차시간

     , CASE WHEN A.LVL = 1  THEN '0500' WHEN A.LVL = 2  THEN '0500' WHEN A.LVL = 3  THEN '0600' WHEN A.LVL = 4  THEN '0600' WHEN A.LVL = 5  THEN '0700' WHEN A.LVL = 6  THEN '0700'
            WHEN A.LVL = 7  THEN '0800' WHEN A.LVL = 8  THEN '0800' WHEN A.LVL = 9  THEN '0900' WHEN A.LVL = 10 THEN '0900' WHEN A.LVL = 11 THEN '1000' WHEN A.LVL = 12 THEN '1000'
            WHEN A.LVL = 13 THEN '1100' WHEN A.LVL = 14 THEN '1100' WHEN A.LVL = 15 THEN '1200' WHEN A.LVL = 16 THEN '1200' WHEN A.LVL = 17 THEN '1300' WHEN A.LVL = 18 THEN '1300'
            WHEN A.LVL = 19 THEN '1400' WHEN A.LVL = 20 THEN '1400' WHEN A.LVL = 21 THEN '1500' WHEN A.LVL = 22 THEN '1500' WHEN A.LVL = 23 THEN '1600' WHEN A.LVL = 24 THEN '1600'
            WHEN A.LVL = 25 THEN '1700' WHEN A.LVL = 26 THEN '1700' WHEN A.LVL = 27 THEN '1800' WHEN A.LVL = 28 THEN '1800' WHEN A.LVL = 29 THEN '1900' WHEN A.LVL = 30 THEN '1900'
            WHEN A.LVL = 31 THEN '2000' WHEN A.LVL = 32 THEN '2000' WHEN A.LVL = 33 THEN '2100' WHEN A.LVL = 34 THEN '2100' WHEN A.LVL = 35 THEN '2200' WHEN A.LVL = 36 THEN '2200'
            WHEN A.LVL = 37 THEN '2300' WHEN A.LVL = 38 THEN '2300' WHEN A.LVL = 39 THEN '2400' WHEN A.LVL = 40 THEN '2400' WHEN A.LVL = 41 THEN '0100' WHEN A.LVL = 42 THEN '0100'
            WHEN A.LVL = 43 THEN '0200' WHEN A.LVL = 44 THEN '0200' WHEN A.LVL = 45 THEN '0300' WHEN A.LVL = 46 THEN '0300' WHEN A.LVL = 47 THEN '0400' WHEN A.LVL = 48 THEN '0400'
            ELSE '' END AS END_TIME		# 하차시간
 
 ## 레벨이 짝수면 하차, 홀수면 승차로 구분하는 코드 부여

     , CASE WHEN MOD(A.LVL, 2) = 1 THEN 'TK'  
            WHEN MOD(A.LVL, 2) = 0 THEN 'GF'  
            ELSE '' END AS TKCAR_GFF_SE_CD

 ## 레벨별로 시간대별 승차, 하차 나눔 (REPLACE로 데이터에 있는 쉼표, 공백 제거)

     , CASE WHEN A.LVL = 1  THEN TO_NUMBER(REPLACE(FROM_04_HOUR_TO_05_HOUR_TK, ',','')) WHEN A.LVL = 2  THEN TO_NUMBER(REPLACE(FROM_04_HOUR_TO_05_HOUR_GFF, ',','')) 
            WHEN A.LVL = 3  THEN TO_NUMBER(REPLACE(FROM_05_HOUR_TO_06_HOUR_TK, ',','')) WHEN A.LVL = 4  THEN TO_NUMBER(REPLACE(FROM_05_HOUR_TO_06_HOUR_GFF, ',','')) 
            WHEN A.LVL = 5  THEN TO_NUMBER(REPLACE(FROM_06_HOUR_TO_07_HOUR_TK, ',','')) WHEN A.LVL = 6  THEN TO_NUMBER(REPLACE(FROM_06_HOUR_TO_07_HOUR_GFF, ',','')) 
            WHEN A.LVL = 7  THEN TO_NUMBER(REPLACE(FROM_07_HOUR_TO_08_HOUR_TK, ',','')) WHEN A.LVL = 8  THEN TO_NUMBER(REPLACE(FROM_07_HOUR_TO_08_HOUR_GFF, ',','')) 
            WHEN A.LVL = 9  THEN TO_NUMBER(REPLACE(FROM_08_HOUR_TO_09_HOUR_TK, ',','')) WHEN A.LVL = 10 THEN TO_NUMBER(REPLACE(FROM_08_HOUR_TO_09_HOUR_GFF, ',','')) 
            WHEN A.LVL = 11 THEN TO_NUMBER(REPLACE(FROM_09_HOUR_TO_10_HOUR_TK, ',','')) WHEN A.LVL = 12 THEN TO_NUMBER(REPLACE(FROM_09_HOUR_TO_10_HOUR_GFF, ',','')) 
            WHEN A.LVL = 13 THEN TO_NUMBER(REPLACE(FROM_10_HOUR_TO_11_HOUR_TK, ',','')) WHEN A.LVL = 14 THEN TO_NUMBER(REPLACE(FROM_10_HOUR_TO_11_HOUR_GFF, ',','')) 
            WHEN A.LVL = 15 THEN TO_NUMBER(REPLACE(FROM_11_HOUR_TO_12_HOUR_TK, ',','')) WHEN A.LVL = 16 THEN TO_NUMBER(REPLACE(FROM_11_HOUR_TO_12_HOUR_GFF, ',','')) 
            WHEN A.LVL = 17 THEN TO_NUMBER(REPLACE(FROM_12_HOUR_TO_13_HOUR_TK, ',','')) WHEN A.LVL = 18 THEN TO_NUMBER(REPLACE(FROM_12_HOUR_TO_13_HOUR_GFF, ',','')) 
            WHEN A.LVL = 19 THEN TO_NUMBER(REPLACE(FROM_13_HOUR_TO_14_HOUR_TK, ',','')) WHEN A.LVL = 20 THEN TO_NUMBER(REPLACE(FROM_13_HOUR_TO_14_HOUR_GFF, ',','')) 
            WHEN A.LVL = 21 THEN TO_NUMBER(REPLACE(FROM_14_HOUR_TO_15_HOUR_TK, ',','')) WHEN A.LVL = 22 THEN TO_NUMBER(REPLACE(FROM_14_HOUR_TO_15_HOUR_GFF, ',','')) 
            WHEN A.LVL = 23 THEN TO_NUMBER(REPLACE(FROM_15_HOUR_TO_16_HOUR_TK, ',','')) WHEN A.LVL = 24 THEN TO_NUMBER(REPLACE(FROM_15_HOUR_TO_16_HOUR_GFF, ',','')) 
            WHEN A.LVL = 25 THEN TO_NUMBER(REPLACE(FROM_16_HOUR_TO_17_HOUR_TK, ',','')) WHEN A.LVL = 26 THEN TO_NUMBER(REPLACE(FROM_16_HOUR_TO_17_HOUR_GFF, ',','')) 
            WHEN A.LVL = 27 THEN TO_NUMBER(REPLACE(FROM_17_HOUR_TO_18_HOUR_TK, ',','')) WHEN A.LVL = 28 THEN TO_NUMBER(REPLACE(FROM_17_HOUR_TO_18_HOUR_GFF, ',','')) 
            WHEN A.LVL = 29 THEN TO_NUMBER(REPLACE(FROM_18_HOUR_TO_19_HOUR_TK, ',','')) WHEN A.LVL = 30 THEN TO_NUMBER(REPLACE(FROM_18_HOUR_TO_19_HOUR_GFF, ',','')) 
            WHEN A.LVL = 31 THEN TO_NUMBER(REPLACE(FROM_19_HOUR_TO_20_HOUR_TK, ',','')) WHEN A.LVL = 32 THEN TO_NUMBER(REPLACE(FROM_19_HOUR_TO_20_HOUR_GFF, ',','')) 
            WHEN A.LVL = 33 THEN TO_NUMBER(REPLACE(FROM_20_HOUR_TO_21_HOUR_TK, ',','')) WHEN A.LVL = 34 THEN TO_NUMBER(REPLACE(FROM_20_HOUR_TO_21_HOUR_GFF, ',','')) 
            WHEN A.LVL = 35 THEN TO_NUMBER(REPLACE(FROM_21_HOUR_TO_22_HOUR_TK, ',','')) WHEN A.LVL = 36 THEN TO_NUMBER(REPLACE(FROM_21_HOUR_TO_22_HOUR_GFF, ',','')) 
            WHEN A.LVL = 37 THEN TO_NUMBER(REPLACE(FROM_22_HOUR_TO_23_HOUR_TK, ',','')) WHEN A.LVL = 38 THEN TO_NUMBER(REPLACE(FROM_22_HOUR_TO_23_HOUR_GFF, ',','')) 
            WHEN A.LVL = 39 THEN TO_NUMBER(REPLACE(FROM_23_HOUR_TO_24_HOUR_TK, ',','')) WHEN A.LVL = 40 THEN TO_NUMBER(REPLACE(FROM_23_HOUR_TO_24_HOUR_GFF, ',','')) 
            WHEN A.LVL = 41 THEN TO_NUMBER(REPLACE(FROM_24_HOUR_TO_01_HOUR_TK, ',','')) WHEN A.LVL = 42 THEN TO_NUMBER(REPLACE(FROM_24_HOUR_TO_01_HOUR_GFF, ',','')) 
            WHEN A.LVL = 43 THEN TO_NUMBER(REPLACE(FROM_01_HOUR_TO_02_HOUR_TK, ',','')) WHEN A.LVL = 44 THEN TO_NUMBER(REPLACE(FROM_01_HOUR_TO_02_HOUR_GFF, ',','')) 
            WHEN A.LVL = 45 THEN TO_NUMBER(REPLACE(FROM_02_HOUR_TO_03_HOUR_TK, ',','')) WHEN A.LVL = 46 THEN TO_NUMBER(REPLACE(FROM_02_HOUR_TO_03_HOUR_GFF, ',','')) 
            WHEN A.LVL = 47 THEN TO_NUMBER(REPLACE(FROM_03_HOUR_TO_04_HOUR_TK, ',','')) WHEN A.LVL = 48 THEN TO_NUMBER(REPLACE(FROM_03_HOUR_TO_04_HOUR_GFF, ',','')) 
            ELSE 0 END AS NMPR_CO

 ## 데이터를 48개 복제(24시간 상,하차 구분을 위해)

  FROM 
     (
       SELECT A.*, B.*
         FROM TB_PBTRNSP_DATA A
            , (SELECT LEVEL LVL FROM DUAL CONNECT BY LEVEL <= 48) B	
     ) A

ORDER BY TO_NUMBER(STATN_NO), BEGIN_TIME, END_TIME;

COMMIT; 



# 승차, 하차 인원이 가장 많고 적은 역 모두 구하기

## 역별 승하차별 합계 정렬하기

SELECT A.STATN_NO
     , A.STATN_NM
     , A.HO_LN
     , TKCAR_GFF_SE_CD
     , SUM(A.NMPR_CNT) AS NMPR_CNT

  FROM TB_PBTRNSP A
 WHERE A.STD_MT = '202010'
 GROUP BY A.STATN_NO, A.STATN_NM, A.HO_LN, A.TKCAR_GFF_SE_CD

 ORDER BY NMPR_CNT DESC;

## 위에 작업한 것을 기준으로 작업

SELECT * 
  FROM 
(

### 4. 승하차별 인원 낮은 순위, 높은 순위 번호 메기기

SELECT A.STATN_NO, A.STATN_NM, A.HO_LN 
     , A.TK_NMPR_CNT, A.GF_NMPR_CNT
     , ROW_NUMBER() OVER(ORDER BY A.TK_NMPR_CNT) RN_TK_NMPR_CNT_ASC
     , ROW_NUMBER() OVER(ORDER BY A.TK_NMPR_CNT DESC) RN_TK_NMPR_CNT_DESC
     , ROW_NUMBER() OVER(ORDER BY A.GF_NMPR_CNT) RN_GF_NMPR_CNT_ASC
     , ROW_NUMBER() OVER(ORDER BY A.GF_NMPR_CNT DESC) RN_GF_NMPR_CNT_DESC

  FROM 
      (             

### 3. 승차, 하차 인원수 칼럼 분류한 것 정리

            SELECT A.STATN_NO, A.STATN_NM, A.HO_LN
                 , MAX(A.TK_NMPR_CNT) TK_NMPR_CNT
                 , MAX(A.GF_NMPR_CNT) GF_NMPR_CNT
            FROM 
               (

### 2. 승차, 하차 인원수 칼럼 분류

                SELECT 
                       A.STATN_NO, A.STATN_NM, A.HO_LN
                     , CASE WHEN A.TKCAR_GFF_SE_CD = 'TK' THEN NMPR_CNT ELSE 0 END AS TK_NMPR_CNT
                     , CASE WHEN A.TKCAR_GFF_SE_CD = 'GF' THEN NMPR_CNT ELSE 0 END AS GF_NMPR_CNT

### 1. 지하철역 정보 및 승하차별 인원의 합 정렬

                  FROM 
                     (
                        SELECT A.STATN_NO, A.STATN_NM, A.HO_LN, A.TKCAR_GFF_SE_CD
                             , SUM(A.NMPR_CNT) AS NMPR_CNT
                          FROM TB_PBTRNSP A
                         WHERE A.STD_MT = '202010'
                         GROUP BY A.STATN_NO, A.STATN_NM, A.HO_LN, A.TKCAR_GFF_SE_CD
                         ORDER BY NMPR_CNT DESC
                     ) A
                ) A 
            GROUP BY A.STATN_NO, A.STATN_NM, A.HO_LN
     ) A
) 

### 5. 각 순위별 1위만 뽑아내기

WHERE RN_TK_NMPR_CNT_ASC = 1 OR RN_TK_NMPR_CNT_DESC = 1  OR RN_GF_NMPR_CNT_ASC = 1  OR RN_GF_NMPR_CNT_DESC = 1  ;



# 출근 시간대에, 하차 인원이 가장 많은 역 구하기

### 3. 호선정보, (정리된)출근시간대 하차 인원수 출력

SELECT 
       A.STATN_NO
     , A.STATN_NM
     , A.HO_LN
     , A.NMPR_CNT  
  FROM 
     (

### 2. 출근시간 하차 정보 긁어온것 인원 합 구하기

        SELECT A.STATN_NO
             , A.STATN_NM
             , A.HO_LN
             , SUM(A.NMPR_CNT) AS NMPR_CNT 

### 1. 출근시간(8~9시)의 하차 정보에만 긁어오고 정렬

          FROM TB_PBTRNSP A
          WHERE A.STD_MT = '202010'
            AND A.BEGIN_TIME = '0800'
            AND A.END_TIME = '0900'
            AND A.TKCAR_GFF_SE_CD = 'GF'
         GROUP BY A.STATN_NO, A.STATN_NM, A.HO_LN
         ORDER BY NMPR_CNT DESC
     ) A 

### 4. 상위 10개역만 보여주기

 WHERE ROWNUM <= 10;




# 퇴근시간대 하차 인원이 가장 많은역 구하기

### 3. 호선정보, (정리된)출근시간대 하차 인원수 출력

SELECT 
       A.STATN_NO
     , A.STATN_NM
     , A.HO_LN
     , A.NMPR_CNT  
  FROM 
     (

### 2. 퇴근시간 하차 정보 긁어온것 인원 합 구하기

        SELECT A.STATN_NO
             , A.STATN_NM
             , A.HO_LN
             , SUM(A.NMPR_CNT) AS NMPR_CNT 

### 1. 퇴근시간(18~19시)의 하차 정보에만 긁어오고 정렬

          FROM TB_PBTRNSP A
          WHERE A.STD_MT = '202010'
            AND A.BEGIN_TIME = ‘1800'
            AND A.END_TIME = ‘1900'
            AND A.TKCAR_GFF_SE_CD = 'GF'
         GROUP BY A.STATN_NO, A.STATN_NM, A.HO_LN
         ORDER BY NMPR_CNT DESC
     ) A 

### 4. 상위 10개역만 보여주기

 WHERE ROWNUM <= 10;



# 23시 이후 사람들이 가장 많이 승차하는 역 구하기(막차)

### 3. 2번 과정 거친 데이터 출력

SELECT 
       A.STATN_NO
     , A.STATN_NM
     , A.HO_LN
     , A.NMPR_CNT  
  FROM 
     (

### 2. 1번 작업 인원수 합치기

        SELECT A.STATN_NO
             , A.STATN_NM
             , A.HO_LN
             , SUM(A.NMPR_CNT) AS NMPR_CNT 

### 1.시간대 (23시~4시)의 ‘승차’ 데이터를 가져와서 정렬

          FROM TB_PBTRNSP A
          WHERE A.STD_MT = '202010'
            AND (A.BEGIN_TIME, A.END_TIME) IN ( ('2300', '2400'), ('0000', '0100'), ('0100', '0200'), ('0200', '0300'), ('0300', '0400'))             
            AND A.TKCAR_GFF_SE_CD = 'TK'
         GROUP BY A.STATN_NO, A.STATN_NM, A.HO_LN
         ORDER BY NMPR_CNT DESC
     ) A 

### 4. 상위 10개 출력

 WHERE ROWNUM <= 10;



# 호선별 승하차 인원수가 가장 많은 역 구하기

### 4. 3번 작업한거 전부 출력하기

SELECT * 
  FROM 
     (

### 3. 호선을 파티션별로 나눠서 승하차 인원 내림차순으로 정렬해서 번호 메기기

SELECT   
         A.STATN_NO
 , A.STATN_NM
 , A.HO_LN 
 , A.NMPR_CNT
 , ROW_NUMBER() OVER(PARTITION BY A.HO_LN ORDER BY A.NMPR_CNT DESC) AS RN_HO_LN_NMPR_CN
  FROM 
     (

### 2. 호선별 승차+하차 인원의 합계

SELECT
       A.STATN_NO
     , A.STATN_NM
     , A.HO_LN
     , SUM(A.NMPR_CNT) AS NMPR_CNT

### 1. 승하차 별도 구분 없이 역,호선정보 그룹화(승하차 인원수별 정렬)

  FROM TB_PBTRNSP A
 WHERE A.STD_MT = '202010'
 GROUP BY A.STATN_NO, A.STATN_NM, A.HO_LN
 ORDER BY NMPR_CNT DESC
     ) A 
     ) A      

### 5. 4번 과정에서 정리된 내역 중 호선별 1등만 출력하고 역순 정렬(많은 역부터 출력)

WHERE RN_HO_LN_NMPR_CNT = 1
ORDER BY NMPR_CNT DESC
;





SQL 온라인 강의4

 # 상권정보 데이터 분석
  - 데이터가 지역별로 있고, 대전만 구분이 쉼표로 되어있다.
  - 그 데이터만 txt로 변경하고 다른 데이터는 하나로 만들어라


# 테이블 생성 및 데이터 입력 TB_TRDAR_DATA
CREATE TABLE TB_TRDAR_DATA
(
  TRDAR_NO VARCHAR2(4000) NOT NULL
, CMPNM_NM VARCHAR2(4000)
, BHF_NM VARCHAR2(4000)
, TRDAR_INDUTY_LRGE_CL_CD VARCHAR2(4000)
, TRDAR_INDUTY_LRGE_CL_NM VARCHAR2(4000)
, TRDAR_INDUTY_MIDDL_CL_CD VARCHAR2(4000)
, TRDAR_INDUTY_MIDDL_CL_NM VARCHAR2(4000)
, TRDAR_INDUTY_SMALL_CL_CD VARCHAR2(4000)
, TRDAR_INDUTY_SMALL_CL_NM VARCHAR2(4000)
, STD_INDUST_CL_CD VARCHAR2(4000)
, STD_INDUST_CL_NM VARCHAR2(4000)
, CTPRVN_CD VARCHAR2(4000)
, CTPRVN_NM VARCHAR2(4000)
, SIGNGU_CD VARCHAR2(4000)
, SIGNGU_NM VARCHAR2(4000)
, ADSTRD_CD VARCHAR2(4000)
, ADSTRD_NM VARCHAR2(4000)
, LEGALDONG_CD VARCHAR2(4000)
, LEGALDONG_NM VARCHAR2(4000)
, LNM_CD VARCHAR2(4000)
, PLOT_SE_CD VARCHAR2(4000)
, PLOT_SE_NM VARCHAR2(4000)
, LNM_MAIN_LNBR VARCHAR2(4000)
, LNM_SUB_LNBR VARCHAR2(4000)
, LNM_ADRES VARCHAR2(4000)
, RN_CD VARCHAR2(4000)
, RN VARCHAR2(4000)
, BULD_MAIN_LNBR VARCHAR2(4000)
, BULD_SUB_LNBR VARCHAR2(4000)
, BULD_MANAGE_NO VARCHAR2(4000)
, BULD_NM VARCHAR2(4000)
, RN_ADRES VARCHAR2(4000)
, OLD_ZIP VARCHAR2(4000)
, NW_ZIP VARCHAR2(4000)
, DONG_INFO VARCHAR2(4000)
, FLOOR_INFO VARCHAR2(4000)
, HO_INFO VARCHAR2(4000)
, LO VARCHAR2(4000)
, LA VARCHAR2(4000)
);

## 대전 파일은 구분자가 달라  txt로 따로 저장해놨다. 이 파일도 임포트해서 추가하기(설정변경)

## 데이터가 잘 들어갔는지 확인
SELECT COUNT(*) FROM TB_TRDAR_DATA;

 ### 데이터 중간에 타이틀이 들어가있어서 이걸 걸러줘야한다.
DELETE FROM TB_TRDAR_DATA WHERE TRDAR_NO = '상가업소번호'; 
COMMIT; 

# 테이블 재설정 TB_TRDAR
 - 위의 데이터는 데이터 량이 얼마나 있는지 몰라서 4000으로 크게 잡았다.
 - 따라서, 길이에 맞게 재 조정한 테이블을 만들자

CREATE TABLE TB_TRDAR
(
  TRDAR_NO CHAR(8) NOT NULL
, CMPNM_NM VARCHAR2(150) NOT NULL
, BHF_NM VARCHAR2(100)
, TRDAR_INDUTY_LRGE_CL_CD VARCHAR2(6) NOT NULL
, TRDAR_INDUTY_LRGE_CL_NM VARCHAR2(100)
, TRDAR_INDUTY_MIDDL_CL_CD VARCHAR2(6) NOT NULL
, TRDAR_INDUTY_MIDDL_CL_NM VARCHAR2(100)
, TRDAR_INDUTY_SMALL_CL_CD VARCHAR2(6) NOT NULL
, TRDAR_INDUTY_SMALL_CL_NM VARCHAR2(100)
, STD_INDUST_CL_CD VARCHAR2(6)
, STD_INDUST_CL_NM VARCHAR2(100)
, CTPRVN_CD VARCHAR2(10) NOT NULL
, CTPRVN_NM VARCHAR2(100) NOT NULL
, SIGNGU_CD VARCHAR2(10) NOT NULL
, SIGNGU_NM VARCHAR2(100) NOT NULL
, ADSTRD_CD VARCHAR2(10) NOT NULL
, ADSTRD_NM VARCHAR2(50)
, LEGALDONG_CD VARCHAR2(10)
, LEGALDONG_NM VARCHAR2(50)
, LNM_CD VARCHAR2(19) NOT NULL
, PLOT_SE_CD VARCHAR2(1) NOT NULL
, PLOT_SE_NM VARCHAR2(100)
, LNM_MAIN_LNBR VARCHAR2(4) NOT NULL
, LNM_SUB_LNBR VARCHAR2(4)
, LNM_ADRES VARCHAR2(150) NOT NULL
, RN_CD VARCHAR2(12) NOT NULL
, RN VARCHAR2(150)
, BULD_MAIN_LNBR VARCHAR2(5) NOT NULL
, BULD_SUB_LNBR VARCHAR2(4)
, BULD_MANAGE_NO VARCHAR2(25) NOT NULL
, BULD_NM VARCHAR2(100)
, RN_ADRES VARCHAR2(150) NOT NULL
, OLD_ZIP VARCHAR2(6)
, NW_ZIP VARCHAR2(5)
, DONG_INFO VARCHAR2(50)
, FLOOR_INFO VARCHAR2(50)
, HO_INFO VARCHAR2(50)
, LO NUMBER(16,13) NOT NULL
, LA NUMBER(16,13) NOT NULL
, CONSTRAINT TB_TRDAR_PK PRIMARY KEY (TRDAR_NO) 
);

## 재생성된 테이블에 데이터 다시 집어넣기
INSERT /*+ APPEND */ INTO TB_TRDAR T 
SELECT * FROM TB_TRDAR_DATA A 
;

COMMIT; 

### 제대로 들어갔는지 재확인
SELECT COUNT(*) FROM TB_TRDAR; 


# 서울시 강남구 기준 각 업종별 상가의 수가 많은 순으로 조회하기

## 2. 필요한 정보 출력하기 / COUNT(*) CNT로 상가수 합계

SELECT A.CTPRVN_CD
     , A.CTPRVN_NM
     , A.SIGNGU_CD
     , A.SIGNGU_NM        
     , A.TRDAR_INDUTY_LRGE_CL_CD		— 해당 부분을 중분류/소분류로 바꿔서 조회 할 수 있다.
     , A.TRDAR_INDUTY_LRGE_CL_NM
     , COUNT(*) CNT

## 1. TB_TRDAR 테이블 조회해서 강남구 자료 가져오기

  FROM TB_TRDAR A
 WHERE SIGNGU_CD = '11680' --강남구
 GROUP BY A.CTPRVN_CD, A.CTPRVN_NM, A.SIGNGU_CD, A.SIGNGU_NM, A.TRDAR_INDUTY_LRGE_CL_CD , A.TRDAR_INDUTY_LRGE_CL_NM 

## 3. 상가수가 많은 순으로 출력

 ORDER BY CNT DESC;

### 위의 과정을 INDEX 설정을 통해 연산을 빠르게 한다.
 - 시군구 코드를 지정해줌으로써 연산을 더 빠르게 할 수 있다.

CREATE INDEX IDX_TB_TRDAR_01 ON TB_TRDAR(SIGNGU_CD); 



# 각 지역별 스타벅스 매장 수 구하기

## 3. 정리된 자료 출력

SELECT 
       * 

## 2. 1번에 구분된 자료를 출력(가게 합계)

  FROM 
     (
        SELECT A.CTPRVN_CD
             , A.CTPRVN_NM
             , A.SIGNGU_CD
             , A.SIGNGU_NM
             , A.ADSTRD_CD
             , A.ADSTRD_NM
             , COUNT(*) CNT

## 1. CMPNM_NM 열에서 ‘스타벅스’라는 단어를 포함하거나, 대분자로 바꿨을때 STAR BUCKS를 포함하는 것 구분 

          FROM TB_TRDAR A
         WHERE (   A.CMPNM_NM LIKE '%스타벅스%'
                OR UPPER(A.CMPNM_NM) LIKE '%' || UPPER('STAR')||'%'||UPPER('BUCKS')||'%'
               )
           AND A.TRDAR_INDUTY_SMALL_CL_CD = 'Q12A01' --커피전문점/카페/다방

### 읍면동 별로 그룹화

           GROUP BY A.CTPRVN_CD, A.CTPRVN_NM, A.SIGNGU_CD, A.SIGNGU_NM, A.ADSTRD_CD, A.ADSTRD_NM
           ORDER BY CNT DESC
     ) A

## 4. 상위 10개 지역 출력

WHERE ROWNUM <= 10;

### INDEX로 계산 효율 높이기

CREATE INDEX IDX_TB_TRDAR_02 ON TB_TRADAR(TRDAR_INDUTY_SMALL_CL_CD);


# 지역별 인구수 대비 커피전문점 개수 구하기

## 5. 출력

SELECT * 

## 4. 2번 작업으로 된 자료를 활용해서 매장 1개당 인구수 구하기

  FROM 
     (
SELECT A.ADMINIST_ZONE_NO
     , A.ADMINIST_ZONE_NM
     , A.SIGNGU_CD
     , A."인구수"
     , A."커피전문점매장수"
     , TRUNC(A."인구수"/A."커피전문점매장수") "매장1개당인구수"

## 2. 각 지역 인구수 및 커피전문점 매장 수 구하기 (1-2에서 조인한 데이터 활용)

  FROM 
     (
        SELECT A.ADMINIST_ZONE_NO, A.ADMINIST_ZONE_NM, A.POPLTN_CNT "인구수",B.SIGNGU_CD, COUNT(*) AS "커피전문점매장수"

## 1. 2010년 10월 기준, 전국 각 지역 인구수 구하기 / 기존 인구 데이터를 활용

          FROM 
             (
               SELECT A.ADMINIST_ZONE_NO, A.ADMINIST_ZONE_NM , SUM(A.POPLTN_CNT) AS POPLTN_CNT

                 FROM TB_POPLTN A 
                WHERE A.STD_MT = '202010'
                  AND A.POPLTN_SE_CD = 'T'                  
                  AND A.ADMINIST_ZONE_NO LIKE '_____00000'                    
                  GROUP BY A.ADMINIST_ZONE_NO, A.ADMINIST_ZONE_NM 
             ) A 

### 1-1. 상권 테이블

             , TB_TRDAR B 

### 1-2. A에서 지역구와 상권테이블(B)의 시군구코드와 JOIN함

         WHERE SUBSTR(A.ADMINIST_ZONE_NO, 1, 5) = B.SIGNGU_CD 
           AND B.TRDAR_INDUTY_SMALL_CL_CD = 'Q12A01' --커피전문점/카페/다방
           GROUP BY A.ADMINIST_ZONE_NO, A.ADMINIST_ZONE_NM, A.POPLTN_CNT, B.SIGNGU_CD
           ORDER BY A.ADMINIST_ZONE_NO, A.ADMINIST_ZONE_NM
     )  A 

## 3. 매장 1개당 인구수 역순출력

ORDER BY "매장1개당인구수" DESC    
    ) 

## 5. 상위 10개 출력

WHERE ROWNUM <= 10;



# 지역별 인구수(00세~19세) 대비 학원의 개수 구하기

## 5. 출력

SELECT * 

## 4. 학원수 1개당 인구수 만들기

  FROM 
     (
SELECT A.ADMINIST_ZONE_NO
     , A.ADMINIST_ZONE_NM
     , A.SIGNGU_CD
     , A."인구수"
     , A."학원수"
     , TRUNC(A."인구수"/A."학원수") "학원수1개당인구수"

## 3. 학원수, 인구수 구하기

  FROM 
     (
        SELECT A.ADMINIST_ZONE_NO, A.ADMINIST_ZONE_NM, A.POPLTN_CNT "인구수",B.SIGNGU_CD, COUNT(*) AS "학원수"

## 2. 1에서 정리된 그룹화된 테이블에서 인구수를 합침

          FROM 
             (
               SELECT A.ADMINIST_ZONE_NO, A.ADMINIST_ZONE_NM , SUM(A.POPLTN_CNT) AS POPLTN_CNT

## 1. 인구수 테이블에서 지역별 연령대 00~10대 인구수를 뽑기

                 FROM TB_POPLTN A 
                WHERE A.STD_MT = '202010'
                  AND A.POPLTN_SE_CD = 'T'
                  AND A.AGRDE_SE_CD IN ('000', '010')
                  AND A.ADMINIST_ZONE_NO LIKE '_____00000'                    
                  GROUP BY A.ADMINIST_ZONE_NO, A.ADMINIST_ZONE_NM 
             ) A 

### 1-2. 상권데이터 B로 설정
             , TB_TRDAR B 

### 1-3. 지역별 데이터에 상권의 지역 데이터 JOIN하기/학문,교육 대상

         WHERE SUBSTR(A.ADMINIST_ZONE_NO, 1, 5) = B.SIGNGU_CD 
           AND B.TRDAR_INDUTY_LRGE_CL_CD = 'R' --학문/교육
           GROUP BY A.ADMINIST_ZONE_NO, A.ADMINIST_ZONE_NM, A.POPLTN_CNT, B.SIGNGU_CD
           ORDER BY A.ADMINIST_ZONE_NO, A.ADMINIST_ZONE_NM
     )  A 

## 5. 역순 정렬

ORDER BY "학원수1개당인구수" DESC    
) 

## 상위 10개 출력

WHERE ROWNUM <= 10;


